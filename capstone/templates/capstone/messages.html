{% extends "capstone/layout.html" %}

{% block body %}

    <script>
        $('.button--bubble').each(function() {
        var $circlesTopLeft = $(this).parent().find('.circle.top-left');
        var $circlesBottomRight = $(this).parent().find('.circle.bottom-right');

        var tl = new TimelineLite();
        var tl2 = new TimelineLite();

        var btTl = new TimelineLite({ paused: true });

        tl.to($circlesTopLeft, 1.2, { x: -25, y: -25, scaleY: 2, ease: SlowMo.ease.config(0.1, 0.7, false) });
        tl.to($circlesTopLeft.eq(0), 0.1, { scale: 0.2, x: '+=6', y: '-=2' });
        tl.to($circlesTopLeft.eq(1), 0.1, { scaleX: 1, scaleY: 0.8, x: '-=10', y: '-=7' }, '-=0.1');
        tl.to($circlesTopLeft.eq(2), 0.1, { scale: 0.2, x: '-=15', y: '+=6' }, '-=0.1');
        tl.to($circlesTopLeft.eq(0), 1, { scale: 0, x: '-=5', y: '-=15', opacity: 0 });
        tl.to($circlesTopLeft.eq(1), 1, { scaleX: 0.4, scaleY: 0.4, x: '-=10', y: '-=10', opacity: 0 }, '-=1');
        tl.to($circlesTopLeft.eq(2), 1, { scale: 0, x: '-=15', y: '+=5', opacity: 0 }, '-=1');

        var tlBt1 = new TimelineLite();
        var tlBt2 = new TimelineLite();
        
        tlBt1.set($circlesTopLeft, { x: 0, y: 0, rotation: -45 });
        tlBt1.add(tl);

        tl2.set($circlesBottomRight, { x: 0, y: 0 });
        tl2.to($circlesBottomRight, 1.1, { x: 30, y: 30, ease: SlowMo.ease.config(0.1, 0.7, false) });
        tl2.to($circlesBottomRight.eq(0), 0.1, { scale: 0.2, x: '-=6', y: '+=3' });
        tl2.to($circlesBottomRight.eq(1), 0.1, { scale: 0.8, x: '+=7', y: '+=3' }, '-=0.1');
        tl2.to($circlesBottomRight.eq(2), 0.1, { scale: 0.2, x: '+=15', y: '-=6' }, '-=0.2');
        tl2.to($circlesBottomRight.eq(0), 1, { scale: 0, x: '+=5', y: '+=15', opacity: 0 });
        tl2.to($circlesBottomRight.eq(1), 1, { scale: 0.4, x: '+=7', y: '+=7', opacity: 0 }, '-=1');
        tl2.to($circlesBottomRight.eq(2), 1, { scale: 0, x: '+=15', y: '-=5', opacity: 0 }, '-=1');
        
        tlBt2.set($circlesBottomRight, { x: 0, y: 0, rotation: 45 });
        tlBt2.add(tl2);

        btTl.add(tlBt1);
        btTl.to($(this).parent().find('.button.effect-button'), 0.8, { scaleY: 1.1 }, 0.1);
        btTl.add(tlBt2, 0.2);
        btTl.to($(this).parent().find('.button.effect-button'), 1.8, { scale: 1, ease: Elastic.easeOut.config(1.2, 0.4) }, 1.2);

        btTl.timeScale(2.6);

        $(this).on('mouseover', function() {
            btTl.restart();
        });
        });
        function read(message_id){
        fetch(`/read_message/${message_id}`)
        .then(response => response.text())
        .then(text => {
            var message_div = document.getElementById(message_id)
            message_div.classList.remove('unread')

            message_div.querySelector('.dot').setAttribute("hidden","")
        })
        }

    </script>


<div>
    <svg xmlns="http://www.w3.org/2000/svg" version="1.1" class="goo">
      <defs>
        <filter id="goo">
          <feGaussianBlur in="SourceGraphic" stdDeviation="10" result="blur" />
          <feColorMatrix in="blur" mode="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 19 -9" result="goo" />
          <feComposite in="SourceGraphic" in2="goo"/>
        </filter>
      </defs>
    </svg>
    
    <span class="button--bubble__container">
      <a href="#campaign" class="button button--bubble">
        Hover me
      </a>
      <span class="button--bubble__effect-container">
        <span class="circle top-left"></span>
        <span class="circle top-left"></span>
        <span class="circle top-left"></span>
    
        <span class="button effect-button"></span>
    
        <span class="circle bottom-right"></span>
        <span class="circle bottom-right"></span>
        <span class="circle bottom-right"></span>
      </span>
    </span>
    </div>

    {% if message %}
    <div class="alert alert-danger" role="alert">
        {{message}}
    </div>
    {% endif %}

    <form action="{% url 'send_message' %}" method="POST">
        {% csrf_token %}
        <div class="form-group">
            <textarea name="content" id="content" cols="30" rows="5" class="form-control" placeholder="Type here the message"></textarea>
            <select name="receiver" id="receiver_select" class="selectpicker" data-live-search="true">
                <option value="" selected disabled>Select a receiver</option>
                {% for user in users %}
                <option value="{{user.id}}">{{user.username}}</option>
                {% endfor %}    
            </select>
        </div>
        <button type="submit">Send</button>
    </form>
    <h5>Received messages</h5>
    {% if received_messages %}
        <ul>
            {% for message in received_messages %}
            {% if message.read|stringformat:'r' == 'True'%}
                <li>
                    <div>{{message.receiver}}: {{message.content}}</div><small>{{message.timestamp}}</small>
                    <hr>
                </li>
            {% else %}
            <li>
                <div class="unread" id="{{message.id}}" onclick="read({{message.id}})"> <span class="dot"></span>
                    <span class="strong">{{message.receiver}}: {{message.content}}</span>
                    <div class="timestamp">{{message.timestamp}}</div>
                </div>
                <hr>
            </li>
            {% endif %}
            {% endfor %}
        </ul>
    {% else %}
        <strong>No messages :(</strong>
        <hr> 
    {% endif %}

    <h5>Sent messages</h5>
    {% if sent_messages %}
        <ul>
            {% for message in sent_messages %}
                <li>
                    <div>{{message.receiver}}: {{message.content}}</div> <small>{{message.timestamp}}</small><hr>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        No messages
    {% endif %}
    




{% endblock %}